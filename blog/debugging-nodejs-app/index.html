<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Debugging high CPU usage and memory leak on Nodejs application ::
        jaanhio
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="Recently one of our nodejs application (responsible for scraping metrics for external services) running in our EKS cluster was experiencing high CPU usage and memory leak and I was tasked to figure out the root cause. In this post, I will share my troubleshooting process and interesting stuff I discovered along the way.
It all began with an alert notifying us of the application experiencing CPU throttling. Looking at the dashboard, it became apparent that high CPU usage isn&amp;rsquo;t the only issue; it was also experiencing memory leak and oddly high incoming and outgoing traffic."
/>
<meta
  name="keywords"
  content="debug, performance analysis, nodejs"
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="/blog/debugging-nodejs-app/" />





<link rel="stylesheet" href="/assets/style.css" />

<link rel="stylesheet" href="/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="/img/favicon.png" />


<link href="/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Debugging high CPU usage and memory leak on Nodejs application"/>
<meta name="twitter:description" content="Recently one of our nodejs application (responsible for scraping metrics for external services) running in our EKS cluster was experiencing high CPU usage and memory leak and I was tasked to figure out the root cause. In this post, I will share my troubleshooting process and interesting stuff I discovered along the way.
It all began with an alert notifying us of the application experiencing CPU throttling. Looking at the dashboard, it became apparent that high CPU usage isn&rsquo;t the only issue; it was also experiencing memory leak and oddly high incoming and outgoing traffic."/>



<meta property="og:title" content="Debugging high CPU usage and memory leak on Nodejs application" />
<meta property="og:description" content="Recently one of our nodejs application (responsible for scraping metrics for external services) running in our EKS cluster was experiencing high CPU usage and memory leak and I was tasked to figure out the root cause. In this post, I will share my troubleshooting process and interesting stuff I discovered along the way.
It all began with an alert notifying us of the application experiencing CPU throttling. Looking at the dashboard, it became apparent that high CPU usage isn&rsquo;t the only issue; it was also experiencing memory leak and oddly high incoming and outgoing traffic." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/blog/debugging-nodejs-app/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2021-09-04T15:28:44+08:00" />
<meta property="article:modified_time" content="2021-09-04T15:28:44+08:00" />



<meta name="description" content="I write about tech and more!" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >$</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About me</a></li>
        
      
        
          <li><a href="/collection">Collection</a></li>
        
      
        
          <li><a href="/moments">Moments</a></li>
        
      
        
          <li><a href="/projects">Projects</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About me</a></li>
      
    
      
        <li><a href="/collection">Collection</a></li>
      
    
      
        <li><a href="/moments">Moments</a></li>
      
    
      
        <li><a href="/projects">Projects</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Debugging high CPU usage and memory leak on Nodejs application</h1>
    <div class="post-meta">
      
        <span class="post-date">
          6 Sep 2021
        </span>

        
          
        
      

      


      
        <span class="post-read-time"
          >— 7 min read</span
        >
      
    </div>

    
      <span class="post-tags">
        
          <a href="/tags/debug/">#debug</a>&nbsp;
        
          <a href="/tags/performance-analysis/">#performance analysis</a>&nbsp;
        
          <a href="/tags/nodejs/">#nodejs</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <p>Recently one of our nodejs application (responsible for scraping metrics for external services) running in our EKS cluster was experiencing high CPU usage and memory leak and I was tasked to figure out the root cause.
In this post, I will share my troubleshooting process and interesting stuff I discovered along the way.</p>
<p>It all began with an alert notifying us of the application experiencing CPU throttling. Looking at the dashboard, it became apparent that high CPU usage isn&rsquo;t the only issue; it was also experiencing memory leak and oddly high incoming and outgoing traffic.</p>
<p><figure class="post-cover">
    <input type="checkbox" id="old-cpu-usage.png">
      <label for="old-cpu-usage.png">
        <img src="old-cpu-usage.png" alt="" />
      </label>
    
      <figcaption class="center">CPU usage</figcaption>
    
</figure>
<figure class="post-cover">
    <input type="checkbox" id="old-cpu-throttling.png">
      <label for="old-cpu-throttling.png">
        <img src="old-cpu-throttling.png" alt="" />
      </label>
    
      <figcaption class="center">CPU throttling</figcaption>
    
</figure>
<figure class="post-cover">
    <input type="checkbox" id="old-memory-usage.png">
      <label for="old-memory-usage.png">
        <img src="old-memory-usage.png" alt="" />
      </label>
    
      <figcaption class="center">Memory usage</figcaption>
    
</figure>
<figure class="post-cover">
    <input type="checkbox" id="old-network-bandwidth.png">
      <label for="old-network-bandwidth.png">
        <img src="old-network-bandwidth.png" alt="" />
      </label>
    
      <figcaption class="center">Network bandwidth</figcaption>
    
</figure>
<figure class="post-cover">
    <input type="checkbox" id="old-packet-rate.png">
      <label for="old-packet-rate.png">
        <img src="old-packet-rate.png" alt="" />
      </label>
    
      <figcaption class="center">Packet rate</figcaption>
    
</figure></p>
<p>I also noticed the application producing a rather large amount of error logs (approximately 20logs/s).</p>
<p>I checked the application to verify the logic for triggering the scrape. It does so using an infinite recursive loop with delays between scrape implemented via <code>setTimeout</code> delays.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">exec</span>(<span style="color:#a6e22e">asyncFunc</span>, <span style="color:#a6e22e">delay</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">asyncFunc</span>();
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">e</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#39;Error executing&#39;</span>, <span style="color:#a6e22e">e</span>);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setTimeout</span>(() =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">exec</span>(<span style="color:#a6e22e">asyncFunc</span>, <span style="color:#a6e22e">delay</span>);
</span></span><span style="display:flex;"><span>    }, <span style="color:#a6e22e">delay</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><hr>
<h2 id="setup">Setup</h2>
<p>First thing I did was to install some additional tools on the container to provide more visibility as to what exactly is running (note: you might need to make some additional modifications to pod configurations in order run the following tools as root).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apt update <span style="color:#f92672">&amp;&amp;</span> apt install -y strace lsof net-tools
</span></span></code></pre></div><p><code>strace</code>: Tool that traces syscalls. Goal is to find out which syscalls are taking large percentage of CPU time.</p>
<p><code>lsof</code>: Tool to list open files. Goal is to find out what connections are there.</p>
<p><code>net-tools</code>: This package contains a variety of tools (e.g <code>arp</code>, <code>hostname</code>, <code>netstat</code> etc). I am installing just for using <code>netstat</code>. One can argue that lsof may be able to sufficiently replace use of netstat (check out this <a href="https://danielmiessler.com/study/lsof/">awesome guide on lsof</a>), but I haven&rsquo;t figure how to use <code>lsof</code> to also display the <code>recv-q</code> and <code>send-q</code> data.</p>
<hr>
<h2 id="inspecting-connections">Inspecting connections</h2>
<p>I first used <code>lsof</code> to find out more information on the connections within pod.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># lsof -i</span>
</span></span><span style="display:flex;"><span>COMMAND PID USER   FD   TYPE    DEVICE SIZE/OFF NODE NAME
</span></span><span style="display:flex;"><span>node     <span style="color:#ae81ff">18</span> root   19u  IPv6 <span style="color:#ae81ff">249577828</span>      0t0  TCP *:9999 <span style="color:#f92672">(</span>LISTEN<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>node     <span style="color:#ae81ff">18</span> root   20u  IPv4 <span style="color:#ae81ff">249738893</span>      0t0  TCP exporter:52984-&gt;some-ip:9243 <span style="color:#f92672">(</span>ESTABLISHED<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>node     <span style="color:#ae81ff">18</span> root   21u  IPv4 <span style="color:#ae81ff">249573270</span>      0t0  TCP exporter:55846-&gt;some-ip2:9243 <span style="color:#f92672">(</span>ESTABLISHED<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>node     <span style="color:#ae81ff">18</span> root   23u  IPv4 <span style="color:#ae81ff">249573271</span>      0t0  TCP exporter:35286-&gt;some-ip3:9243 <span style="color:#f92672">(</span>ESTABLISHED<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>node     <span style="color:#ae81ff">18</span> root   24u  IPv4 <span style="color:#ae81ff">249734064</span>      0t0  TCP exporter:53960-&gt;some-ip4:9243 <span style="color:#f92672">(</span>ESTABLISHED<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>node     <span style="color:#ae81ff">18</span> root   25u  IPv4 <span style="color:#ae81ff">249743967</span>      0t0  TCP exporter:57936-&gt;some-ip:9243 <span style="color:#f92672">(</span>ESTABLISHED<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>..
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># lsof -i | grep 9243 | wc </span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">256</span>
</span></span></code></pre></div><p>Excluding the header row and the only listening connection, there&rsquo;s a total of 256 connections, all to a bunch of IP addresses on port 9243. A quick Google search revealed that port 9243 is commonly used by ElasticCloud. Indeed, we do use <code>winston-elasticsearch</code> library for establishing transport of logs to ElasticCloud.</p>
<p>I restarted the application multiple times while varying the duration between scrape and observed the number of connections created. Turns out it did not start with 256 connections but instead increases over time. Increasing the duration between scrape slowed down the rate of increase of connections. It also reduced the amount of logs produced.</p>
<p><figure class="post-cover">
    <input type="checkbox" id="container-sockets.png">
      <label for="container-sockets.png">
        <img src="container-sockets.png" alt="" />
      </label>
    
      <figcaption class="center">Container sockets</figcaption>
    
</figure>
<figure class="post-cover">
    <input type="checkbox" id="container-fd.png">
      <label for="container-fd.png">
        <img src="container-fd.png" alt="" />
      </label>
    
      <figcaption class="center">Container FD</figcaption>
    
</figure></p>
<p>Notice that number of connections is capped at 256? Definitely not a coincidence and some code somewhere is somehow limiting the max number of connections.</p>
<p>I also used <code>netstat</code> to get information on the <code>recv-q</code> and <code>send-q</code> on each socket.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># netstat -ntp</span>
</span></span><span style="display:flex;"><span>Active Internet connections <span style="color:#f92672">(</span>w/o servers<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
</span></span><span style="display:flex;"><span>tcp     <span style="color:#ae81ff">1101</span>      <span style="color:#ae81ff">0</span> 10.189.2.170:43536      some-ip:9243      ESTABLISHED       19/node
</span></span><span style="display:flex;"><span>tcp     <span style="color:#ae81ff">1101</span>      <span style="color:#ae81ff">0</span> 10.189.2.170:51434      some-ip:9243      ESTABLISHED       19/node
</span></span><span style="display:flex;"><span>tcp     <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">443</span> 10.189.2.170:43534      some-ip:9243      ESTABLISHED       19/node
</span></span><span style="display:flex;"><span>tcp     <span style="color:#ae81ff">1101</span>      <span style="color:#ae81ff">0</span> 10.189.2.170:47432      some-ip:9243      ESTABLISHED       19/node
</span></span><span style="display:flex;"><span>tcp     <span style="color:#ae81ff">1101</span>      <span style="color:#ae81ff">0</span> 10.189.2.170:47384      some-ip:9243      ESTABLISHED       19/node
</span></span><span style="display:flex;"><span>tcp     <span style="color:#ae81ff">1101</span>      <span style="color:#ae81ff">0</span> 10.189.2.170:34586      some-ip:9243      ESTABLISHED       19/node
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>..
</span></span><span style="display:flex;"><span>.
</span></span></code></pre></div><p>As the name suggests, <code>recv-q</code> and <code>send-q</code> are the receive and send queues/buffer for a particular socket and indicates the number of bytes in the queue/buffer. Having non-zero value under any of the queue columns indicates that data is not being processed fast enough, which could be due to an abnormally large volume of data or something is slowing down the processing.</p>
<p>I also noticed that <code>recv-q</code> bytes is capped at <code>1101</code> and <code>send-q</code> is capped at <code>443</code>.</p>
<hr>
<h2 id="inspecting-cpu-load">Inspecting CPU load</h2>
<p>Wanting to figure out which syscall is responsible for the bulk of CPU time, I attached <code>strace</code> to the node process and passed a <code>-c</code> flag to return a summary of syscalls traced. (note: <code>strace</code> introduces a significant amount of performance overhead and is not recommended to run in production environment. For that, <code>perf</code> will be a better tool)</p>
<pre tabindex="0"><code># strace -p 25 -c
strace: Process 25 attached
^Cstrace: Process 25 detached
% time     seconds  usecs/call     calls    errors syscall
------ ----------- ----------- --------- --------- ----------------
 40.31    0.297807           8     39518           clock_gettime
 16.37    0.120910          22      5481         7 write
 12.05    0.089027           9      9968           gettimeofday
  8.51    0.062851         101       624           epoll_wait
  6.71    0.049588          10      5162           read
  5.70    0.042095          13      3280       146 futex
  5.54    0.040911           9      4616           epoll_ctl
  4.58    0.033837           9      3810           getpid
  0.17    0.001259           9       148           mprotect
  0.03    0.000244           9        26           mmap
  0.03    0.000230           9        26           munmap
  0.00    0.000022           6         4         1 writev
------ ----------- ----------- --------- --------- ----------------
100.00    0.738781                 72663       154 total
</code></pre><p><code>clock_gettime</code>, <code>write</code>, <code>gettimeofday</code>?</p>
<p>I came across an article on <a href="https://asafdav2.github.io/2017/node-js-timers/">nodejs timers</a>, which covers how timers are managed internally and one particular line stood out to me</p>
<blockquote>
<p>On top of user code and 3rd-party libraries using timers, timers are also used internally by the Node.js platform itself. For example, a dedicated timer is used with each TCP connection to detect a possible connection timeout.</p>
</blockquote>
<p>Timer for connections? Well, this application has create 256 connections to ElasticCloud. And it sure is sending a non-trivial amount of error logs to ElasticCloud, which could explain the high <code>% time</code> used by <code>write</code>.</p>
<p>At this point, my hypothesis for the root cause of high CPU usage and memory leak: use of <code>winston-elasticsearch</code> library coupled with the huge amount of logs being shipped through it.</p>
<p>I could have just removed the use of <code>winston-elasticsearch</code> in the application to verify my hypothesis but I wanted to dig deeper.</p>
<hr>
<h2 id="cpu-and-memory-profiling-of-application">CPU and memory profiling of application</h2>
<p>For debugging purpose, I ran the application locally with <code>--inspect</code> flag and managed to replicate the same issue.</p>
<p>When a Nodejs process application is started with <code>--inspect</code> flag, the Nodejs process will listen for a debugging client. There are multiple clients available; I used Chrome Devtools. See <a href="https://nodejs.org/en/docs/guides/debugging-getting-started/">debugging guide</a> for more information.</p>
<p>I then captured the CPU and memory profile.</p>
<p><figure class="post-cover">
    <input type="checkbox" id="cpu-profile.png">
      <label for="cpu-profile.png">
        <img src="cpu-profile.png" alt="" />
      </label>
    
      <figcaption class="center">CPU profile</figcaption>
    
</figure>
From the CPU profile, we can see large percentage of CPU time used by <code>EventEmitter.emit</code>, with some of source files being <code>_stream_readable.js</code>, <code>_http_client.js</code>, <code>Transport.js</code>, <code>bulk_writer.js</code>, <code>Connection.js</code>.</p>
<p>Aha! These files are related to <code>winston-elasticsearch</code> library.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">ElasticsearchTransport</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;winston-elasticsearch&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ElasticsearchTransport</span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">readable</span><span style="color:#f92672">-</span><span style="color:#a6e22e">stream</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-&gt;</span> <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">elastic</span><span style="color:#f92672">/</span><span style="color:#a6e22e">elasticsearch</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">winston</span><span style="color:#f92672">-</span><span style="color:#a6e22e">elasticsearch</span>
</span></span></code></pre></div><p>After spending some time tracing calls with debugger, I found the answer to the 256 connections limit: <a href="https://github.com/elastic/elasticsearch-js/blob/b67d42cb5ff7a39a1836d176266ac32af9e72f07/lib/Connection.js#L63">https://github.com/elastic/elasticsearch-js/blob/b67d42cb5ff7a39a1836d176266ac32af9e72f07/lib/Connection.js#L63</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">agentOptions</span> <span style="color:#f92672">=</span> Object.<span style="color:#a6e22e">assign</span>({}, {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">keepAlive</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">keepAliveMsecs</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1000</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">maxSockets</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">256</span>, <span style="color:#f92672">&lt;---------------</span> <span style="color:#f92672">!!</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">maxFreeSockets</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">256</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">scheduling</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;lifo&#39;</span>
</span></span><span style="display:flex;"><span>      }, <span style="color:#a6e22e">opts</span>.<span style="color:#a6e22e">agent</span>)
</span></span></code></pre></div><p>Depending on the options (<code>opts.proxy</code>) passed, the creation of sockets is handled either by Nodejs <code>http</code> or <code>https</code> module or <code>hpagent</code> (which uses <code>http</code>/<code>https</code> modules under-the-hood), which reminds me of the <a href="https://medium.com/the-node-js-collection/why-the-hell-would-you-use-node-js-4b053b94ab8e">power of Nodejs and event loop</a> to support large number of concurrent connections</p>
<p>Now for the memory profile.
<figure class="post-cover">
    <input type="checkbox" id="memory-profile.png">
      <label for="memory-profile.png">
        <img src="memory-profile.png" alt="" />
      </label>
    
      <figcaption class="center">Memory profile</figcaption>
    
</figure></p>
<p>I will not be sharing details of the objects captured due to potentially sensitive information but the bulk of it are these:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>(<span style="color:#a6e22e">array</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">objects</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">connections</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">ElasticCloud</span>
</span></span><span style="display:flex;"><span>(<span style="color:#a6e22e">string</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">payload</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">each</span> <span style="color:#a6e22e">log</span> (<span style="color:#a6e22e">looking</span> <span style="color:#a6e22e">closely</span>, <span style="color:#a6e22e">we</span> <span style="color:#a6e22e">can</span> <span style="color:#a6e22e">see</span> <span style="color:#a6e22e">theres</span> <span style="color:#a6e22e">many</span> <span style="color:#a6e22e">references</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">timers</span>.<span style="color:#a6e22e">js</span>. <span style="color:#66d9ef">this</span> <span style="color:#a6e22e">matches</span> <span style="color:#a6e22e">what</span> <span style="color:#a6e22e">was</span> <span style="color:#a6e22e">mentioned</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">nodejs</span> <span style="color:#a6e22e">timers</span> <span style="color:#a6e22e">article</span> <span style="color:#a6e22e">above</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#a6e22e">closure</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">response</span> <span style="color:#a6e22e">objects</span>...<span style="color:#a6e22e">perhaps</span> <span style="color:#a6e22e">from</span> <span style="color:#a6e22e">ElasticCloud</span>
</span></span></code></pre></div><hr>
<h2 id="final-verification">Final verification</h2>
<p>I removed the use of <code>winston-elasticsearch</code> library and wala. Also, this library is no longer needed since we have <code>fluent-bit</code> running in our EKS clusters for shipping logs.</p>
<p>Below are diagrams comparing before and after change was made (new pod metrics in TEAL color).
<figure class="post-cover">
    <input type="checkbox" id="new-cpu-usage.png">
      <label for="new-cpu-usage.png">
        <img src="new-cpu-usage.png" alt="" />
      </label>
    
      <figcaption class="center">CPU usage</figcaption>
    
</figure>
<figure class="post-cover">
    <input type="checkbox" id="new-memory-usage.png">
      <label for="new-memory-usage.png">
        <img src="new-memory-usage.png" alt="" />
      </label>
    
      <figcaption class="center">Memory usage</figcaption>
    
</figure>
<figure class="post-cover">
    <input type="checkbox" id="new-network-bandwidth.png">
      <label for="new-network-bandwidth.png">
        <img src="new-network-bandwidth.png" alt="" />
      </label>
    
      <figcaption class="center">Network bandwidth</figcaption>
    
</figure>
<figure class="post-cover">
    <input type="checkbox" id="new-packet-rate.png">
      <label for="new-packet-rate.png">
        <img src="new-packet-rate.png" alt="" />
      </label>
    
      <figcaption class="center">Packet rate</figcaption>
    
</figure></p>
<hr>
<h2 id="key-takeaways">Key takeaways</h2>
<p>Tools are only as powerful as the wielder.</p>
<p>I have always believed in understanding the fundamentals of various topics/domains and not take the blackbox approach when using libraries/tools/frameworks and this experience has reinforced that belief.</p>
<p>Honestly, I probably wouldn&rsquo;t even know where to start if I didn&rsquo;t have basic understanding of syscalls, linux networking, nodejs internals and the use of tools such as debugger, <code>strace</code>, <code>lsof</code>, <code>netcat</code>.</p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="/blog/nodejs-flamegraph-analysis/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Nodejs application CPU profile analysis with Flame Graphs</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="/blog/understanding-alertmanager/">
                  <span class="button__text">Understanding the differences between alertmanager&#39;s group_wait, group_interval and repeat_interval</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        
      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span
          >© 2023 Powered by
          <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span
        >
      </div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script><script src="/searchbar.js"></script>

      
    </div>

    
      
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SX2DZ2KVGS"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-SX2DZ2KVGS', { 'anonymize_ip': false });
}
</script>

    
  </body>
</html>
