<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Visualizing alerts metrics on Grafana ::
        jaanhio
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="When it comes to Prometheus and alerts, the typical use case is to send alerts to Alertmanager for handling (deduplication, grouping) and routing them to the various services such Slack, PagerDuty etc.
However, there might be situations where we might need to perform analysis on alert patterns and being able to visualize how often the alerts are firing can be very useful.
In this post, I will share how we can visualize the alert metrics on Grafana using the various PromQL operators and functions."
/>
<meta
  name="keywords"
  content="prometheus, monitoring, grafana"
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="/blog/visualizing-alerts-metrics-grafana/" />





<link rel="stylesheet" href="/assets/style.css" />

<link rel="stylesheet" href="/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="/img/favicon.png" />


<link href="/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Visualizing alerts metrics on Grafana"/>
<meta name="twitter:description" content="When it comes to Prometheus and alerts, the typical use case is to send alerts to Alertmanager for handling (deduplication, grouping) and routing them to the various services such Slack, PagerDuty etc.
However, there might be situations where we might need to perform analysis on alert patterns and being able to visualize how often the alerts are firing can be very useful.
In this post, I will share how we can visualize the alert metrics on Grafana using the various PromQL operators and functions."/>



<meta property="og:title" content="Visualizing alerts metrics on Grafana" />
<meta property="og:description" content="When it comes to Prometheus and alerts, the typical use case is to send alerts to Alertmanager for handling (deduplication, grouping) and routing them to the various services such Slack, PagerDuty etc.
However, there might be situations where we might need to perform analysis on alert patterns and being able to visualize how often the alerts are firing can be very useful.
In this post, I will share how we can visualize the alert metrics on Grafana using the various PromQL operators and functions." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/blog/visualizing-alerts-metrics-grafana/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2021-09-26T13:44:24+08:00" />
<meta property="article:modified_time" content="2021-09-26T13:44:24+08:00" /><meta property="og:site_name" content="jaanhio" />




<meta name="description" content="I write about tech and more!" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >$</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About me</a></li>
        
      
        
          <li><a href="/collection">Collection</a></li>
        
      
        
          <li><a href="/projects">Projects</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About me</a></li>
      
    
      
        <li><a href="/collection">Collection</a></li>
      
    
      
        <li><a href="/projects">Projects</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Visualizing alerts metrics on Grafana</h1>
    <div class="post-meta">
      
        <span class="post-date">
          6 Sep 2021
        </span>

        
          
        
      

      


      
        <span class="post-read-time"
          >— 3 min read</span
        >
      
    </div>

    
      <span class="post-tags">
        
          <a href="/tags/prometheus/">#prometheus</a>&nbsp;
        
          <a href="/tags/monitoring/">#monitoring</a>&nbsp;
        
          <a href="/tags/grafana/">#grafana</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <p>When it comes to Prometheus and alerts, the typical use case is to send alerts to Alertmanager for handling (deduplication, grouping) and routing them to the various services such Slack, PagerDuty etc.</p>
<p>However, there might be situations where we might need to perform analysis on alert patterns and being able to visualize how often the alerts are firing can be very useful.</p>
<p>In this post, I will share how we can visualize the alert metrics on Grafana using the various <a href="https://prometheus.io/docs/prometheus/latest/querying/basics/">PromQL operators and functions</a>.</p>
<hr>
<h2 id="choosing-the-metrics">Choosing the metrics</h2>
<p>Prometheus exposes 2 alert metrics: <code>ALERTS</code> and <code>ALERTS_FOR_STATE</code>.</p>
<p><code>ALERTS</code> time series provide information on the state of a triggered alert via the <code>alertstate</code> label. An alert can be either in a &ldquo;firing&rdquo; or &ldquo;pending&rdquo; state. When an alert is first triggered (i.e alert rule PromQL returns matching time series), it will transitioned into &ldquo;pending&rdquo; state. If an alert stays in the &ldquo;pending&rdquo; state for the specified duration set in <code>for</code> key in alert rule (i.e alert rule PromQL consistently returns matching time series), it will transition to &ldquo;firing&rdquo; state. This is when an alert gets fired to Alertmanager for handling. See <a href="https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/#defining-alerting-rules">docs</a> for more information.</p>
<p>Example:</p>
<pre tabindex="0"><code>ALERTS{alertname=&#34;Watchdog&#34;, alertstate=&#34;firing&#34;, severity=&#34;none&#34;}   1
</code></pre><p><code>ALERTS_FOR_STATE</code> time series provide information on the start time (Unix epoch time format) of triggered alerts that are in either &ldquo;firing&rdquo; or &ldquo;pending&rdquo; state.</p>
<p>Example:</p>
<pre tabindex="0"><code>ALERTS_FOR_STATE{alertname=&#34;Watchdog&#34;, severity=&#34;none&#34;}    1632807871
</code></pre><h2 id="breaking-down-the-promql">Breaking down the PromQL</h2>
<p>This is PromQL used:</p>
<pre tabindex="0"><code>(sum by (alertname) (changes(ALERTS_FOR_STATE[48h]) AND ignoring(alertstate) max_over_time(ALERTS{alertstate=&#34;firing&#34;}[48h])) + (count by (alertname) (changes(ALERTS_FOR_STATE[48h]) AND ignoring(alertstate) max_over_time(ALERTS{alertstate=&#34;firing&#34;}[48h])) * 1))
</code></pre><p>Looks confusing eh? Let&rsquo;s break it down a little.</p>
<p><code>changes(ALERTS_FOR_STATE[48h])</code> returns an instant vector telling us how many times a triggered alert&rsquo;s timestamp has changed. Each change indicates an alert being triggered to either &ldquo;pending&rdquo; or &ldquo;firing&rdquo; state.</p>
<p><code>max_over_time(ALERTS{alertstate=&quot;firing&quot;}[48h]</code> returns an instant vector containing time series of alerts that have been in the &ldquo;firing&rdquo; state. <code>max_over_time</code> can technically be replaced with other functions that can return the same instant vector.</p>
<p>Combining it with the <code>AND</code> <a href="https://prometheus.io/docs/prometheus/latest/querying/operators/#logical-set-binary-operators">binary operator</a>, we can match labels and filter to get a count of how many times a &ldquo;firing&rdquo; alert has been triggered (i.e firing throughout the threshold duration).</p>
<p>Now we want to sum the alert counts computed above by the <code>alertname</code>, hence the <code>sum by (alertname)</code>.</p>
<p>The latter portion of PromQL (<code>count by (alertname) (changes(ALERTS_FOR_STATE[48h]) AND ignoring(alertstate) max_over_time(ALERTS{alertstate=&quot;firing&quot;}[48h])) * 1)</code>) is a trick to ensure that the count of each of the time series (alert) computed is incremented by 1. This is because an alert going from not existing (no <code>ALERTS_FOR_STATE</code> metric available) to existing is not counted as a change in value, thus the need to increment by 1.</p>
<p>Combining them together:
<figure class="post-cover">
    <input type="checkbox" id="alert-metrics-bar.png">
      <label for="alert-metrics-bar.png">
        <img src="alert-metrics-bar.png" alt="alert-metrics-bar" />
      </label>
    
</figure></p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="/blog/nsenter-debug/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Debugging containers using nsenter</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="/blog/debugging-prometheus-alert/">
                  <span class="button__text">Debugging a misfiring Prometheus alert</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        
      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span
          >© 2022 Powered by
          <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span
        >
      </div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script><script src="/searchbar.js"></script>

      
    </div>

    
      
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SX2DZ2KVGS"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-SX2DZ2KVGS', { 'anonymize_ip': false });
}
</script>

    
  </body>
</html>
